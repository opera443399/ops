pipeline {
  agent {
    node {
      //------ åˆ†é…ä»»åŠ¡ç»™æ‰“äº†ä¸‹è¿°æ ‡ç­¾çš„ worker
      label 'pipeline_only'
      //------ æŒ‡å®šå¹²æ´»çš„è·¯å¾„
      customWorkspace '/data/server/jenkins_worker/code/demoproject/src/demoproject'
    }
  }

  parameters {
    //------ å®šä¹‰å‚æ•°(ç¯å¢ƒå˜é‡)
    string(name: 'SVC_NAMES', defaultValue: 'svc1,svc2,svc3', description: 'è¯·é€‰æ‹©å¾®æœåŠ¡ï¼ˆä½¿ç”¨é€—å·ä½œä¸ºåˆ†éš”ç¬¦ï¼Œæ— ç©ºæ ¼ï¼‰: \nsvc1,svc2,svc3')
    string(name: 'SVC_VERSION', defaultValue: 'EMPTY', description: 'è¯·æŒ‡å®š`docker image tag`çš„å€¼ï¼Œé»˜è®¤å°†æå– `git rev id`')
    string(name: 'GIT_BRANCH_NAME', defaultValue: 'develop', description: 'è¯·æŒ‡å®š git åˆ†æ”¯ï¼š')
    choice(name: 'CICD_ENV', choices: 'dev\ntest', description: 'è¯·é—®æ‚¨è¦éƒ¨ç½²è‡³å“ªä¸€ä¸ªç¯å¢ƒä¸­å‘¢ï¼Ÿ')
    choice(name: 'CICD_OP', choices: 'deploy\nrollback', description: 'è¯·é€‰æ‹©æ“ä½œç±»å‹ï¼š')
  }

  environment {
    // å®šä¹‰ golang ç¯å¢ƒå˜é‡
    GOPATH = '/data/server/jenkins_worker/code/demoproject'
  }

  stages {
    stage('å‡†å¤‡ git ä»“åº“') {
      when {
        expression {
          //------ åªåœ¨ dev ç¯å¢ƒä¸­æ‰§è¡Œ
          (params.CICD_ENV=='dev' && params.CICD_OP=='deploy') ? true : false
        }
      }
      steps {
        echo '[+] è·å– git ä»£ç ...'
        checkout([
          $class: 'GitSCM',
          branches: [[
            name: "refs/heads/${GIT_BRANCH_NAME}"
          ]],
          doGenerateSubmoduleConfigurations: false,
          extensions: [],
          submoduleCfg: [],
          userRemoteConfigs: [[
            credentialsId: '11112222-1111-2222-1111-222211112222',
            url: 'git@example.com:group1/demoproject.git'
          ]]
        ])

        echo '[-] ______________________END_OF_STAGE______________________'
      }
    }


    stage('åˆå§‹åŒ–') {
      steps {
        echo '[@] Jenkinsfile for jenkins pipeline'
        echo "[@] ä»»åŠ¡é“¾æ¥ï¼š${BUILD_URL}"
        echo '[+] git logs (æœ€è¿‘3æ¡)'
        sh 'git log -3 --oneline'
        //sh 'git whatchanged -3'

        echo "[+] SVC_VERSION: ${SVC_VERSION} , SVC_NAMES: \n${SVC_NAMES}"
        echo "[+] GIT_BRANCH_NAME: ${GIT_BRANCH_NAME}"
        echo "[+] CICD_ENV: ${CICD_ENV} , CICD_OP: ${CICD_OP}"

        echo '[-] ______________________END_OF_STAGE______________________'
      }
    }


    stage('å›æ»š') {
      when {
        expression {
          //------ åªåœ¨æ“ä½œä¸º rollback æ—¶æ¿€æ´»
          params.CICD_OP == 'rollback'
        }
      }
      steps {
        script {
          //------ tag diff
          if (params.SVC_VERSION == 'EMPTY') {
            env.APP_TAG = sh(returnStdout: true, script: "git rev-parse --short HEAD").trim()
          } else {
            env.APP_TAG = params.SVC_VERSION
          }
          echo "[-] å½“å‰é€‰æ‹©çš„ç‰ˆæœ¬ä¸º: ${APP_TAG} , å¾®æœåŠ¡åŒ…å«: \n${SVC_NAMES}"

          //------ ACL
          userInput = input([
            message: 'å¼€å§‹å›æ»š? (å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬)',
            ok: 'ç¡®è®¤',
            parameters: [
              text(name: 'approvers', defaultValue: 'ğŸ”œğŸ”µadminğŸ”µhanmeimeiğŸ”µlilei', description: 'å®¡æ ¸è€…:')
            ],
            //------ æŒ‡å®šå®¡æ ¸è€…ï¼Œè¯·ä½¿ç”¨é€—å·','ä½œä¸ºåˆ†éš”ç¬¦(æ— ç©ºæ ¼)
            submitter: 'admin,hanmeimei,lilei',
            submitterParameter: 'approverID'

          ])
          echo "[-] ç”± ${userInput['approverID']} å®¡æ ¸é€šè¿‡"
        }

        sh "/bin/bash /data/server/jenkins_worker/cicd/demoproject/ci.sh undo demoproject '${APP_TAG}' '${SVC_NAMES}' '${CICD_ENV}'"

        echo '[-] ______________________END_OF_STAGE______________________'
      }
    }


    stage('æ„å»º') {
      when {
        expression {
          //------ åªåœ¨ dev ç¯å¢ƒä¸­æ‰§è¡Œ
          (params.CICD_ENV=='dev' && params.CICD_OP=='deploy') ? true : false
        }
      }
      tools {
        //------ æŒ‡å®šå…¨å±€å®šä¹‰çš„ä¾èµ–å·¥å…·ï¼Œæ­¤å¤„ä¸º golang ç¯å¢ƒ
        go 'freego'
      }
      steps {
        echo '[+] ä»£ç æ„å»ºä¸­...'

        script {
          //------ tag diff
          if (params.SVC_VERSION == 'EMPTY') {
            env.APP_TAG = sh(returnStdout: true, script: "git rev-parse --short HEAD").trim()
          } else {
            env.APP_TAG = params.SVC_VERSION
          }
          echo "[-] å½“å‰é€‰æ‹©çš„ç‰ˆæœ¬ä¸º: ${APP_TAG} , å¾®æœåŠ¡åŒ…å«: \n${SVC_NAMES}"
        }

        sh "/bin/bash /data/server/jenkins_worker/cicd/demoproject/ci.sh build demoproject '${APP_TAG}' '${SVC_NAMES}' '${CICD_ENV}'"

        echo '[-] ______________________END_OF_STAGE______________________'
      }
    }


    stage('éƒ¨ç½²è‡³ dev ç¯å¢ƒ') {
      when {
        expression {
          //------ åªåœ¨ dev ç¯å¢ƒä¸­æ‰§è¡Œ
          (params.CICD_ENV=='dev' && params.CICD_OP=='deploy') ? true : false
        }
      }
      steps {
        echo '[+] æœåŠ¡ä¸Šçº¿ä¸­...'

        script {
          //------ tag diff
          if (params.SVC_VERSION == 'EMPTY') {
            env.APP_TAG = sh(returnStdout: true, script: "git rev-parse --short HEAD").trim()
          } else {
            env.APP_TAG = params.SVC_VERSION
          }
          echo "[-] å½“å‰é€‰æ‹©çš„ç‰ˆæœ¬ä¸º: ${APP_TAG} , å¾®æœåŠ¡åŒ…å«: \n${SVC_NAMES}"
        }

        sh "/bin/bash /data/server/jenkins_worker/cicd/demoproject/ci.sh rollout demoproject '${APP_TAG}' '${SVC_NAMES}' '${CICD_ENV}'"


        echo '[-] ______________________END_OF_STAGE______________________'
      }
    }


    stage('éƒ¨ç½²è‡³ test ç¯å¢ƒ') {
      when {
        expression {
          //------ åªåœ¨ test ç¯å¢ƒä¸­æ‰§è¡Œ
          (params.CICD_ENV=='test' && params.CICD_OP=='deploy') ? true : false
        }
      }
      steps {
        script {

          //------ tag diff
          if (params.SVC_VERSION == 'EMPTY') {
            env.APP_TAG = sh(returnStdout: true, script: "git rev-parse --short HEAD").trim()
          } else {
            env.APP_TAG = params.SVC_VERSION
          }
          echo "[-] å½“å‰é€‰æ‹©çš„ç‰ˆæœ¬ä¸º: ${APP_TAG} , å¾®æœåŠ¡åŒ…å«: \n${SVC_NAMES}"

          //------ ACL
          userInput = input([
            message: 'æœåŠ¡ä¸Šçº¿ä¸­...(å¾…å®¡æ ¸)',
            ok: 'åŒæ„',
            parameters: [
              text(name: 'approvers', defaultValue: 'ğŸ”œğŸ”µadminğŸ”µhanmeimeiğŸ”µlilei', description: 'å®¡æ ¸è€…:')
            ],
            //------ æŒ‡å®šå®¡æ ¸è€…ï¼Œè¯·ä½¿ç”¨é€—å·','ä½œä¸ºåˆ†éš”ç¬¦(æ— ç©ºæ ¼)
            submitter: 'admin,hanmeimei,lilei',
            submitterParameter: 'approverID'
          ])
          echo "[-] ç”± ${userInput['approverID']} å®¡æ ¸é€šè¿‡"
        }

        sh "/bin/bash /data/server/jenkins_worker/cicd/demoproject/ci.sh rollout demoproject '${APP_TAG}' '${SVC_NAMES}' '${CICD_ENV}'"

        echo '[-] ______________________END_OF_STAGE______________________'
      }
    }


  }
}
