pipeline {
  agent {
    node {
      //------ åˆ†é…ä»»åŠ¡ç»™æ‰“äº†ä¸‹è¿°æ ‡ç­¾çš„ worker
      label 'pipeline_only'
      //------ æŒ‡å®šå¹²æ´»çš„è·¯å¾„
      customWorkspace '/data/server/jenkins_worker/code/demo-web'
    }
  }

  parameters {
    //------ å®šä¹‰å‚æ•°(ç¯å¢ƒå˜é‡)
    string(name: 'GIT_BRANCH_NAME', defaultValue: '*/master', description: 'è¯·æŒ‡å®š git åˆ†æ”¯/ç‰ˆæœ¬å·ï¼š')
    choice(name: 'CICD_ENV', choices: 'qa\nprod', description: 'è¯·é—®æ‚¨è¦éƒ¨ç½²è‡³å“ªä¸€ä¸ªç¯å¢ƒä¸­å‘¢ï¼Ÿ')
    choice(name: 'CICD_OP', choices: 'deploy', description: 'è¯·é€‰æ‹©æ“ä½œç±»å‹ï¼š')
  }

  environment {
    DO_ALERT = 'python /data/server/jenkins_worker/bin/receiver_wechat.py'
  }

  stages {
    stage('å‡†å¤‡ git ä»“åº“') {
      when {
        expression {
          //------ åªåœ¨ dev ç¯å¢ƒä¸­æ‰§è¡Œ
          (params.CICD_OP=='deploy' && (params.CICD_ENV=='qa' || params.CICD_ENV=='prod')) ? true : false
        }
      }
      steps {
        echo '[+] è·å– git ä»£ç ...'
        checkout([
          $class: 'GitSCM',
          branches: [[
            name: "${GIT_BRANCH_NAME}"
          ]],
          doGenerateSubmoduleConfigurations: false,
          extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'src']],
          submoduleCfg: [],
          userRemoteConfigs: [[
            credentialsId: '11112222-1111-2222-1111-222211112222',
            url: 'git@example.com:group1/demoproject.git'
          ]]
        ])

        echo '[-] ______________________END_OF_STAGE______________________'
      }
    }


    stage('åˆå§‹åŒ–') {
      steps {
        echo '[@] Jenkinsfile for jenkins pipeline'
        echo "[@] ä»»åŠ¡é“¾æ¥ï¼š${BUILD_URL}"
        echo '[+] git logs (æœ€è¿‘3æ¡)'
        dir('src') {
          sh 'git log -3 --oneline'
          //sh 'git whatchanged -3'
        }

        echo '[-] ______________________END_OF_STAGE______________________'
      }
    }


    stage('äº¤ä»˜åˆ° qa ç¯å¢ƒ') {
      when {
        expression {
          //------ åªåœ¨ test ç¯å¢ƒä¸­æ‰§è¡Œ
          (params.CICD_ENV=='qa' && params.CICD_OP=='deploy') ? true : false
        }
      }
      steps {
        echo '[+] ä¸Šçº¿æœºå™¨äººï¸ğŸ¤–på°CğŸ¤–å¼€å§‹å¹²æ´»...'
        echo '[-] æ„å»ºä¸­...'
        sh '''
          docker run --rm -v "$(pwd)/src:/code" -w "/code" opera443399/node:9-alpine-taobao npm install
          docker run --rm -v "$(pwd)/src:/code" -w "/code" opera443399/node:9-alpine-taobao npm run build_qa
        '''

        echo '[-] å®¡æ ¸ä¸­...'
        dir('src') {
          script {
            env.APP_TAG = sh(returnStdout: true, script: "git rev-parse --short HEAD").trim()
            echo "[-] å½“å‰é€‰æ‹©çš„ç‰ˆæœ¬ä¸º: ${APP_TAG}"

            //------ ACL-01-START
            sh """
              ${DO_ALERT} 'demo-qa' '[demo-qa]äº¤ä»˜${APP_TAG}[web]ï¼šè¯·[ğŸ”µä»»æ„å‰ç«¯å°ä¼™ä¼´]å®¡æ ¸ã€‚'
            """

            userInput = input([
              message: 'å…è®¸ä¸Šçº¿?',
              ok: 'ç¡®è®¤',
              parameters: [
                text(name: 'approvers', defaultValue: 'ğŸ”œğŸ”µä»»æ„å‰ç«¯å°ä¼™ä¼´', description: 'å®¡æ ¸è€…')
              ],
              //------ æŒ‡å®šå®¡æ ¸è€…ï¼Œè¯·ä½¿ç”¨é€—å·','ä½œä¸ºåˆ†éš”ç¬¦(æ— ç©ºæ ¼)ï¼Œå¯ç”¨è¯·å–æ¶ˆä¸‹é¢ä¸€è¡Œçš„æ³¨é‡Š
              //submitter: 'admin,lilei,hanmeimei',
              submitterParameter: 'approverID'
            ])
            echo "[-] ç”± ${userInput['approverID']} å®¡æ ¸é€šè¿‡"
            sh """
              ${DO_ALERT} 'demo-qa' '[demo-qa]äº¤ä»˜${APP_TAG}[web]ï¼šâœ…[${userInput['approverID']}]å®¡æ ¸é€šè¿‡ã€‚'
            """
            //------ END-OF-ACL-01
          }
        }

        echo '[-] å½’æ¡£æ„å»ºè¾“å‡ºçš„distç›®å½•ï¼š'
        sh '''
          mkdir -p backup/qa
          rsync -avz --delete src/dist backup/qa/${APP_TAG}
          ls -lt backup/qa
        '''

        echo '[-] ä¸Šä¼ åˆ° OSS ä¸­'
        withCredentials([
          usernamePassword(
            credentialsId: 'oss-qa',
            usernameVariable: 'AccessKeyId',
            passwordVariable: 'AccessKeySecret'
            )
          ]) {

          // ossutil
          sh '''
            /usr/local/bin/ossutil -e oss-cn-beijing.aliyuncs.com -i ${AccessKeyId} -k ${AccessKeySecret} cp -r -f -u backup/qa/${APP_TAG}/dist oss://qa/demo
          '''
          echo "[demo-qa]äº¤ä»˜${APP_TAG}[web]ï¼šâœ…[oss]ä¸Šä¼ å®Œæˆã€‚"
        }

        echo '[-] ______________________END_OF_STAGE______________________'
      }

      post {
        success {
            echo 'I succeeeded!'
            sh """
              ${DO_ALERT} 'demo-qa' '[demo-qa]äº¤ä»˜${APP_TAG}[web]ï¼šâœ…ä»»åŠ¡å®Œæˆï¼'
            """
        }
        failure {
            echo 'I failed :('
            sh """
              ${DO_ALERT} 'demo-qa' '[demo-qa]äº¤ä»˜${APP_TAG}[web]ï¼šâŒä»»åŠ¡å¤±è´¥è¯·æ£€æŸ¥ï¼'
            """
        }
      }
    }


    stage('äº¤ä»˜åˆ° prod ç¯å¢ƒ') {
      when {
        expression {
          //------ åªåœ¨ test ç¯å¢ƒä¸­æ‰§è¡Œ
          (params.CICD_ENV=='prod' && params.CICD_OP=='deploy') ? true : false
        }
      }
      steps {
        echo '[+] ä¸Šçº¿æœºå™¨äººï¸ğŸ¤–på°CğŸ¤–å¼€å§‹å¹²æ´»...'
        echo '[-] æ„å»ºä¸­...'
        sh '''
          docker run --rm -v "$(pwd)/src:/code" -w "/code" opera443399/node:9-alpine-taobao npm install
          docker run --rm -v "$(pwd)/src:/code" -w "/code" opera443399/node:9-alpine-taobao npm run build_prod
        '''

        echo '[-] å®¡æ ¸ä¸­...'
        dir('src') {
          script {
            env.APP_TAG = sh(returnStdout: true, script: "git rev-parse --short HEAD").trim()
            echo "[-] å½“å‰é€‰æ‹©çš„ç‰ˆæœ¬ä¸º: ${APP_TAG}"

            //------ ACL-01-START
            sh """
              ${DO_ALERT} 'demo-prod' '[demo-prod]äº¤ä»˜${APP_TAG}[web]ï¼šè¯·[ğŸ”µlilei]å®¡æ ¸ã€‚'
            """

            userInput = input([
              message: 'å…è®¸ä¸Šçº¿?',
              ok: 'ç¡®è®¤',
              parameters: [
                text(name: 'approvers', defaultValue: 'ğŸ”œğŸ”µlilei', description: 'å®¡æ ¸è€…')
              ],
              //------ æŒ‡å®šå®¡æ ¸è€…ï¼Œè¯·ä½¿ç”¨é€—å·','ä½œä¸ºåˆ†éš”ç¬¦(æ— ç©ºæ ¼)ï¼Œå¯ç”¨è¯·å–æ¶ˆä¸‹é¢ä¸€è¡Œçš„æ³¨é‡Š
              submitter: 'admin,lilei',
              submitterParameter: 'approverID'
            ])
            echo "[-] ç”± ${userInput['approverID']} å®¡æ ¸é€šè¿‡"
            sh """
              ${DO_ALERT} 'demo-prod' '[demo-prod]äº¤ä»˜${APP_TAG}[web]ï¼šâœ…[${userInput['approverID']}]å®¡æ ¸é€šè¿‡ã€‚'
            """
            //------ END-OF-ACL-01
          }
        }

        echo '[-] å½’æ¡£æ„å»ºè¾“å‡ºçš„distç›®å½•ï¼š'
        sh '''
          mkdir -p backup/prod
          rsync -avz --delete src/dist backup/prod/${APP_TAG}
          ls -lt backup/prod
        '''

        echo '[-] ä¸Šä¼ åˆ° OSS ä¸­'
        withCredentials([
          usernamePassword(
            credentialsId: 'oss-prod',
            usernameVariable: 'AccessKeyId',
            passwordVariable: 'AccessKeySecret'
            )
          ]) {

          // ossutil
          sh '''
            /usr/local/bin/ossutil -e oss-cn-beijing.aliyuncs.com -i ${AccessKeyId} -k ${AccessKeySecret} cp -r -f -u backup/prod/${APP_TAG}/dist oss://prod/demo
          '''
          echo "[demo-prod]äº¤ä»˜${APP_TAG}[web]ï¼šâœ…[oss]ä¸Šä¼ å®Œæˆã€‚"
        }

        echo '[-] ______________________END_OF_STAGE______________________'
      }

      post {
        success {
            echo 'I succeeeded!'
            sh """
              ${DO_ALERT} 'demo-prod' '[demo-prod]äº¤ä»˜${APP_TAG}[web]ï¼šâœ…ä»»åŠ¡å®Œæˆï¼'
            """
        }
        failure {
            echo 'I failed :('
            sh """
              ${DO_ALERT} 'demo-prod' '[demo-prod]äº¤ä»˜${APP_TAG}[web]ï¼šâŒä»»åŠ¡å¤±è´¥è¯·æ£€æŸ¥ï¼'
            """
        }
      }
    }


  }
}
