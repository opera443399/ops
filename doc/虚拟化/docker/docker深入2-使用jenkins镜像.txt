dockeræ·±å…¥2-ä½¿ç”¨jenkinsé•œåƒ
2016/7/7

ä¸€ã€ç¤ºä¾‹
æµ‹è¯•ç¯å¢ƒåŸºäºæ–‡æ¡£ï¼šdockeræ·±å…¥2-ç†Ÿæ‚‰v1.11å’Œæ‰¾ä¸åŒ.txt
ç›®æ ‡ï¼šç†Ÿæ‚‰ä½¿ç”¨jenkinsé•œåƒï¼Œä» github æ‹‰å–ä»£ç ï¼Œæ„å»ºé•œåƒï¼›
-------------------------------------------------------
---------------------- n36.test -----------------------
                       github
                          â†“
                    jenkins(docker)         172.17.0.13
                    slave_36                172.17.0.1
                          â†“
                 execute shell on salve host slave_36
                          â†“
---------------- build image(slave_36) ----------------
                          â†“
---------------- run container(slave_36) --------------
                          â†“
---------------- push to local registry ---------------
-------------------------------------------------------


äºŒã€åœ¨ docker ç¯å¢ƒä¸­é…ç½® jenkins é•œåƒ
1ã€è·å–
[Jack@n36 jenkins-test]$ docker pull jenkins

2ã€è¿è¡Œ
[Jack@n36 jenkins-test]$ mkdir /data/docker/jenkins-test
[Jack@n36 jenkins-test]$ docker run -d --restart=always -p 8080:8080 -p 50000:50000 -v /data/docker/jenkins-test:/var/jenkins_home --name jenkins_36 jenkins

3ã€é…ç½® jenkins ä¸»æœåŠ¡å™¨çš„ssh keyï¼Œç”¨äºåç»­å¢åŠ  salve èŠ‚ç‚¹æ—¶ï¼Œä½¿ç”¨ public key æ¥éªŒè¯ã€‚
1)è·å– container çš„IP
[Jack@n36 jenkins-test]$ docker inspect -f '{{ .NetworkSettings.IPAddress }}' jenkins_36
172.17.0.13
2)è¿›å…¥ containerï¼Œç”Ÿæˆ ssh key
[Jack@n36 jenkins-test]$ docker exec -it jenkins_36 /bin/bash
jenkins@7da65fcf10ef:/$ ssh-keygen -t rsa -b 2048 -C 'jenkins@docker'
jenkins@7da65fcf10ef:/$ cat ~/.ssh/id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCyvJ8+M2qmxI0lUYt0XWzSQoz7BVttQ/MeFeQlaL+Cf1Wf5WQgP01niDNOiPNEZohSBd9Q6Fc6j2uLWjMot76IGRaQDDPbqvtVs+WHiqFiiTjz/NOIDzS0QsQq4uJau5a+m/mYLqcH3piAwvMGGOOFWtJXPtmpUX31zz0KbO8FnQigYq0vemsKnGw/lezxMbc0WlOesDX1WVtPPgSzWPlwpC3hVYhIVQqjeBVCTrg1tuNG1voyhOwEg6MvPHUrxpWxcYfDj/rM2O6UKSxUjbMCL0LE5gLSsc2iCo9pk8i9/eiMM4S5nWo0Obdv9PG1dQO698DRQMvHzkSZ8hU91LV1 jenkins@docker

3)å°†ä¸Šè¿° id_rsa.pub çš„å†…å®¹æ‹·è´åˆ°ç›®æ ‡æœºå™¨(æœ¬ä¾‹æ˜¯ï¼š172.17.0.1)
åˆ›å»ºä¸€ä¸ªç”¨æˆ· jenkins å¹¶åŠ å…¥ docker ç»„ï¼Œç”¨äºåç»­çš„åœºæ™¯ã€‚
[root@n36 ~]# useradd jenkins
[root@n36 ~]# usermod -a -G docker jenkins
[root@n36 ~]# su jenkins
[jenkins@n36 root]$ cd ~
[jenkins@n36 ~]$ cat .ssh/authorized_keys 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCyvJ8+M2qmxI0lUYt0XWzSQoz7BVttQ/MeFeQlaL+Cf1Wf5WQgP01niDNOiPNEZohSBd9Q6Fc6j2uLWjMot76IGRaQDDPbqvtVs+WHiqFiiTjz/NOIDzS0QsQq4uJau5a+m/mYLqcH3piAwvMGGOOFWtJXPtmpUX31zz0KbO8FnQigYq0vemsKnGw/lezxMbc0WlOesDX1WVtPPgSzWPlwpC3hVYhIVQqjeBVCTrg1tuNG1voyhOwEg6MvPHUrxpWxcYfDj/rM2O6UKSxUjbMCL0LE5gLSsc2iCo9pk8i9/eiMM4S5nWo0Obdv9PG1dQO698DRQMvHzkSZ8hU91LV1 jenkins@docker
æ³¨æ„è¿™ä¸ªæ–‡ä»¶çš„æƒé™ï¼Œé»˜è®¤åˆ›å»ºçš„æ–‡ä»¶æ˜¯æƒé™ä½æ˜¯664ï¼Œå°†å¯¼è‡´sshæ—¶è¢«æ‹’ç»ã€‚
[jenkins@n36 ~]$ ls -l .ssh/authorized_keys  
-rw-rw-r-- 1 jenkins jenkins 396 Jun 30 10:17 .ssh/authorized_keys
è®¾ç½®è¯¥æ–‡ä»¶çš„æƒé™ä½ä¸º644ï¼š
[jenkins@n36 ~]$ chmod 644 .ssh/authorized_keys
[jenkins@n36 ~]$ ls -l .ssh/authorized_keys  
-rw-r--r-- 1 jenkins jenkins 396 Jun 30 10:17 .ssh/authorized_keys


4)æµ‹è¯•ä» jenkins ä¸»èŠ‚ç‚¹ ssh ç™»å½•åˆ° slave èŠ‚ç‚¹çš„è¿é€šæ€§
jenkins@7da65fcf10ef:/$ ssh jenkins@172.17.0.1
Enter passphrase for key '/var/jenkins_home/.ssh/id_rsa': 
Last login: Thu Jun 30 10:45:02 2016
[jenkins@n36 ~]$ exit
logout
Connection to 172.17.0.1 closed.
jenkins@7da65fcf10ef:/$ 

ç¬¦åˆé¢„æœŸã€‚

4ã€ç™»å½•
è®¿é—®ï¼šhttp://IP:8080/
è®¿é—®åçš„é¦–è¦æ­¥éª¤ï¼š
é€‰æ‹©èœå•ï¼šâ€œJenkins-ç³»ç»Ÿç®¡ç†-Configure Global Securityâ€
å…ˆå¢åŠ ä¸€ä¸ªç®¡ç†å‘˜å¸å·å¯†ç ï¼Œè®¾ç½®ä¸€ä¸‹å®‰å…¨é€‰é¡¹ã€‚
åœ¨æ’ä»¶ç®¡ç†é¡µé¢ï¼Œå®‰è£…gitæ’ä»¶ã€‚

5ã€å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼šslave_36ï¼Œä¸“é—¨ç”¨äºæ‰§è¡Œ docker bulid ä»»åŠ¡
æç¤ºï¼šå…ˆæ‰‹åŠ¨ ssh æµ‹è¯•ä¸€ä¸‹è¿é€šæ€§ã€‚(å¦‚æ­¥éª¤3æ‰€ç¤º)

é€‰æ‹©èœå•ï¼šâ€œJenkins-ç³»ç»Ÿç®¡ç†-ç®¡ç†èŠ‚ç‚¹-æ–°å»ºèŠ‚ç‚¹â€
è°ƒæ•´éƒ¨åˆ†é…ç½®ï¼š
------------------------------------------------------------------------------
	Name:                    slave_36
    è¿œç¨‹å·¥ä½œç›®å½•:              /home/jenkins
    ç”¨æ³•:                      åªå…è®¸è¿è¡Œç»‘å®šåˆ°è¿™å°æœºå™¨çš„Job
    å¯åŠ¨æ–¹æ³•:                launch slave agents on unix machines via ssh
    Host:                    172.17.0.1
    Credentials:             (å¯é€‰ ssh password æˆ– key è®¤è¯)
ä¿å­˜
------------------------------------------------------------------------------  


ä¸‰ã€åœ¨ jenkins ä¸­é…ç½®ä¸€ä¸ªä»»åŠ¡
1ã€äº‹å…ˆåœ¨githubä¸Šåˆ›å»ºä¸€ä¸ªç¤ºä¾‹ä»“åº“ï¼Œç”¨äºåç»­é…ç½®çš„ä»»åŠ¡çš„æ„å»ºã€‚
https://github.com/opera443399/docker-example-flask.git

2ã€åˆ›å»ºä¸€ä¸ªä»»åŠ¡
é¡¹ç›®åç§°: docker-example-flask
(å‹¾é€‰)Restrict where this project can be run
        -Label Expression: slave_36

æºç ç®¡ç†:
(å‹¾é€‰)Git
        Repositories	
            Repository URL:	https://github.com/opera443399/docker-example-flask.git

æ„å»º:
        Execute shell
            Command:
------------------------------------------------------------------------------
if [ ! -f 'Dockerfile' ]; then
    echo -e "\n\033[10;1;32m[WARN] `date`, Dockerfile not found!\033[0m\n"
    exit 1
fi
old_image_id=$(docker images |grep example_flask |awk '{print $3}')
docker build -t example_flask .
new_image_id=$(docker images |grep example_flask |awk '{print $3}')
if [ "X${old_image_id}" == "X${new_image_id}" ]; then
    ## new == old
    echo -e "\n\033[10;1;32m[WARN] `date`, the image is not changed.\033[0m\n"
elif [ ! -z ${old_image_id} ]; then
    ## remove the old one
    docker ps -f ancestor="${old_image_id}"
    docker rm -f `docker ps -f ancestor="${old_image_id}" -q`
    docker rmi -f ${old_image_id}
    # new
    docker run -d -P --name j_test_web example_flask
    docker ps -f ancestor="example_flask:latest"
else
    # new
    docker run -d -P --name j_test_web example_flask
    docker ps -f ancestor="example_flask:latest"
fi
------------------------------------------------------------------------------
ä¿å­˜


3ã€å¼€å§‹æ„å»º(gitæºç æœ‰å˜æ›´çš„åœºæ™¯)
æ§åˆ¶å°è¾“å‡º

Started by user admin
Building remotely on slave_36 (build) in workspace /home/jenkins/workspace/docker-example-flask
 > git rev-parse --is-inside-work-tree # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url https://github.com/opera443399/docker-example-flask.git # timeout=10
Fetching upstream changes from https://github.com/opera443399/docker-example-flask.git
 > git --version # timeout=10
 > git -c core.askpass=true fetch --tags --progress https://github.com/opera443399/docker-example-flask.git +refs/heads/*:refs/remotes/origin/*
 > git rev-parse refs/remotes/origin/master^{commit} # timeout=10
 > git rev-parse refs/remotes/origin/origin/master^{commit} # timeout=10
Checking out Revision ee7589867d808e37f25caa5ba57f7b37f0764830 (refs/remotes/origin/master)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f ee7589867d808e37f25caa5ba57f7b37f0764830
 > git rev-list 3cf4b71d1fbafdad58409a923400029560fab1b7 # timeout=10
[docker-example-flask] $ /bin/sh -xe /tmp/hudson6257354915828167074.sh
+ '[' '!' -f Dockerfile ']'
++ docker images
++ grep example_flask
++ awk '{print $3}'
+ old_image_id=705df122c6f4
+ docker build -t example_flask .
Sending build context to Docker daemon 151.6 kB

Step 1 : FROM python:2.7
 ---> a047e3d0ae2b
Step 2 : MAINTAINER PC
 ---> Using cache
 ---> 226defd54560
Step 3 : ADD . /code
 ---> e29eabdfcf6c
Removing intermediate container 9c54acc4b169
Step 4 : WORKDIR /code
 ---> Running in e29cc3197baf
 ---> e477c42451fa
Removing intermediate container e29cc3197baf
Step 5 : RUN pip install -r requirements.txt
 ---> Running in 7484819fb9f9
Collecting flask (from -r requirements.txt (line 1))
  Downloading Flask-0.11.1-py2.py3-none-any.whl (80kB)
Collecting Jinja2>=2.4 (from flask->-r requirements.txt (line 1))
  Downloading Jinja2-2.8-py2.py3-none-any.whl (263kB)
Collecting Werkzeug>=0.7 (from flask->-r requirements.txt (line 1))
  Downloading Werkzeug-0.11.10-py2.py3-none-any.whl (306kB)
Collecting click>=2.0 (from flask->-r requirements.txt (line 1))
  Downloading click-6.6.tar.gz (283kB)
Collecting itsdangerous>=0.21 (from flask->-r requirements.txt (line 1))
  Downloading itsdangerous-0.24.tar.gz (46kB)
Collecting MarkupSafe (from Jinja2>=2.4->flask->-r requirements.txt (line 1))
  Downloading MarkupSafe-0.23.tar.gz
Building wheels for collected packages: click, itsdangerous, MarkupSafe
  Running setup.py bdist_wheel for click: started
  Running setup.py bdist_wheel for click: finished with status 'done'
  Stored in directory: /root/.cache/pip/wheels/b0/6d/8c/cf5ca1146e48bc7914748bfb1dbf3a40a440b8b4f4f0d952dd
  Running setup.py bdist_wheel for itsdangerous: started
  Running setup.py bdist_wheel for itsdangerous: finished with status 'done'
  Stored in directory: /root/.cache/pip/wheels/fc/a8/66/24d655233c757e178d45dea2de22a04c6d92766abfb741129a
  Running setup.py bdist_wheel for MarkupSafe: started
  Running setup.py bdist_wheel for MarkupSafe: finished with status 'done'
  Stored in directory: /root/.cache/pip/wheels/a3/fa/dc/0198eed9ad95489b8a4f45d14dd5d2aee3f8984e46862c5748
Successfully built click itsdangerous MarkupSafe
Installing collected packages: MarkupSafe, Jinja2, Werkzeug, click, itsdangerous, flask
Successfully installed Jinja2-2.8 MarkupSafe-0.23 Werkzeug-0.11.10 click-6.6 flask-0.11.1 itsdangerous-0.24
 ---> 2f1766774e10
Removing intermediate container 7484819fb9f9
Step 6 : EXPOSE 5000
 ---> Running in 0afc7dfd706c
 ---> d4be934c4b82
Removing intermediate container 0afc7dfd706c
Step 7 : CMD python app.py
 ---> Running in 80143492c06f
 ---> 8a7e04e40099
Removing intermediate container 80143492c06f
Successfully built 8a7e04e40099
++ docker images
++ grep example_flask
++ awk '{print $3}'
+ new_image_id=8a7e04e40099
+ '[' X705df122c6f4 == X8a7e04e40099 ']'
+ '[' '!' -z 705df122c6f4 ']'
+ docker ps -f ancestor=705df122c6f4
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                     NAMES
d6cdb6752542        705df122c6f4        "/bin/sh -c 'python a"   12 minutes ago      Up 12 minutes       0.0.0.0:32792->5000/tcp   j_test_web
++ docker ps -f ancestor=705df122c6f4 -q
+ docker rm -f d6cdb6752542
d6cdb6752542
+ docker rmi -f 705df122c6f4
Deleted: sha256:705df122c6f45fd7d14872216df5ac748e7ccd8aeb574c692d6f3ef8e68d3612
Deleted: sha256:0479bb5f6b9bce43653428f5ed230846178e52d929e6a0817ccbb25bbb318e50
Deleted: sha256:efe1492bdf6ab159c1357c04b519e98bd33c17bfd57f1b24384ea7c786b34dd8
Deleted: sha256:5aae0d93bb57f7b4bf4c7151c203f5e0e194a8688c20a756db77d6bda1be216c
Deleted: sha256:933f0804c45e0cd9722280731315f4dcea31a7fc6a48ebf579e161cf28f79347
Deleted: sha256:0c9e6c88927096de37cdbcef1a9de5c9dc45ab1e80a9389d7106b0961874cf15
Deleted: sha256:b6c6b2b55c9e2eaf123777072efa77f35953706a29a93dadaf1ba18ac59a7d34
+ docker run -d -P --name j_test_web example_flask
da59337bc9a72416f1304bf96109ef69cb5a62097a93a12fd267330bc1871136
+ docker ps -f ancestor=example_flask:latest
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                  PORTS                     NAMES
da59337bc9a7        example_flask       "/bin/sh -c 'python a"   1 seconds ago       Up Less than a second   0.0.0.0:32793->5000/tcp   j_test_web
Finished: SUCCESS


4ã€éªŒè¯
imageæ„å»ºå®Œæ¯•åï¼š
[jenkins@n36 docker-example-flask]$ docker images
REPOSITORY                                   TAG                 IMAGE ID            CREATED              SIZE
example_flask                                latest              8a7e04e40099        About a minute ago   694.6 MB

æµ‹è¯•çš„containerçš„çŠ¶æ€ï¼š
[jenkins@n36 docker-example-flask]$ docker ps -f ancestor=example_flask:latest
CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                     NAMES
da59337bc9a7        example_flask       "/bin/sh -c 'python a"   1 seconds ago       Up Less than a second   0.0.0.0:32793->5000/tcp   j_test_web

[jenkins@n36 docker-example-flask]$ curl 172.17.0.1:32793
Hello World! [docker-example-flask]

å˜æ›´è¿‡ç¨‹ï¼Œç¬¦åˆé¢„æœŸã€‚


5ã€å†æ¬¡æ„å»º(gitæºç æ— å˜æ›´çš„åœºæ™¯)
æ§åˆ¶å°è¾“å‡º

Started by user admin
Building remotely on slave_36 (build) in workspace /home/jenkins/workspace/docker-example-flask
 > git rev-parse --is-inside-work-tree # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url https://github.com/opera443399/docker-example-flask.git # timeout=10
Fetching upstream changes from https://github.com/opera443399/docker-example-flask.git
 > git --version # timeout=10
 > git -c core.askpass=true fetch --tags --progress https://github.com/opera443399/docker-example-flask.git +refs/heads/*:refs/remotes/origin/*
 > git rev-parse refs/remotes/origin/master^{commit} # timeout=10
 > git rev-parse refs/remotes/origin/origin/master^{commit} # timeout=10
Checking out Revision ee7589867d808e37f25caa5ba57f7b37f0764830 (refs/remotes/origin/master)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f ee7589867d808e37f25caa5ba57f7b37f0764830
 > git rev-list ee7589867d808e37f25caa5ba57f7b37f0764830 # timeout=10
[docker-example-flask] $ /bin/sh -xe /tmp/hudson288315631585112422.sh
+ '[' '!' -f Dockerfile ']'
++ docker images
++ grep example_flask
++ awk '{print $3}'
+ old_image_id=8a7e04e40099
+ docker build -t example_flask .
Sending build context to Docker daemon 151.6 kB

Step 1 : FROM python:2.7
 ---> a047e3d0ae2b
Step 2 : MAINTAINER PC
 ---> Using cache
 ---> 226defd54560
Step 3 : ADD . /code
 ---> Using cache
 ---> e29eabdfcf6c
Step 4 : WORKDIR /code
 ---> Using cache
 ---> e477c42451fa
Step 5 : RUN pip install -r requirements.txt
 ---> Using cache
 ---> 2f1766774e10
Step 6 : EXPOSE 5000
 ---> Using cache
 ---> d4be934c4b82
Step 7 : CMD python app.py
 ---> Using cache
 ---> 8a7e04e40099
Successfully built 8a7e04e40099
++ docker images
++ grep example_flask
++ awk '{print $3}'
+ new_image_id=8a7e04e40099
+ '[' X8a7e04e40099 == X8a7e04e40099 ']'
++ date
+ echo -e '\n\033[10;1;32m[WARN] Thu Jul  7 17:30:12 CST 2016, the image is not changed.\033[0m\n'

[10;1;32m[WARN] Thu Jul  7 17:30:12 CST 2016, the image is not changed.[0m

Finished: SUCCESS


6ã€å†æ¬¡éªŒè¯
[jenkins@n36 docker-example-flask]$ docker images
REPOSITORY                                   TAG                 IMAGE ID            CREATED             SIZE
example_flask                                latest              8a7e04e40099        16 minutes ago      694.6 MB
[jenkins@n36 docker-example-flask]$ docker ps -f ancestor=example_flask:latest
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                     NAMES
da59337bc9a7        example_flask       "/bin/sh -c 'python a"   1 seconds ago       Up 12 minutes   0.0.0.0:32793->5000/tcp   j_test_web

æœªå‘ç”Ÿå˜æ›´ï¼Œç¬¦åˆé¢„æœŸã€‚


7ã€å°ç»“
1)åœ¨ jenkins ä¸­æ·»åŠ  salve èŠ‚ç‚¹ï¼Œç„¶ååœ¨æ–°çš„ä»»åŠ¡ä¸­ï¼Œé…ç½®å¥½ä»£ç ä»“åº“ï¼Œåœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šè¿è¡ŒæŒ‡å®šçš„è„šæœ¬ã€‚
2)åç»­æ€è·¯ï¼šå¢åŠ ä»»åŠ¡è§¦å‘çš„æ¡ä»¶ï¼Œå¹¶æ”¹è¿›è„šæœ¬ï¼ŒéªŒè¯é•œåƒå¹¶ push åˆ° local registry ä¸­ï¼Œç„¶ååœ¨å…¶ä»–ç¯å¢ƒ pull è¿™ä¸ªæ–°çš„é•œåƒã€‚



ZYXWã€å‚è€ƒï¼š
1ã€docker doc
https://github.com/jenkinsci/docker
https://hub.docker.com/_/jenkins/

2ã€jenkins
http://blog.nsfocus.net/jenkins-build-number-machines/
http://www.tuicool.com/articles/fq6rYnz
http://www.cnblogs.com/Leo_wl/p/4314792.html
https://segmentfault.com/a/1190000003732967